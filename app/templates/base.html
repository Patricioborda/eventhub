{% load navbar_link %}

<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <title>{% block title %}EventHub{% endblock %}</title>
    <link
        href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/css/bootstrap.min.css"
        rel="stylesheet"
    >
    <link
        rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"
    >
    <meta
        name="viewport"
        content="width=device-width, initial-scale=1"
    />
</head>

<body>
    <!-- Navbar solo visible si el usuario está autenticado -->
    <nav class="navbar navbar-expand-md bg-body-tertiary shadow-sm">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">EventHub</a>

            {% if user.is_authenticated %}
                <button
                    class="navbar-toggler"
                    type="button"
                    data-bs-toggle="collapse"
                    data-bs-target="#navbar-content"
                    aria-controls="navbar-content"
                    aria-expanded="false"
                    aria-label="Toggle navigation"
                >
                    <span class="navbar-toggler-icon"></span>
                </button>

                <div class="collapse navbar-collapse" id="navbar-content">
                    <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                        <li class="nav-item">
                            {% navbar_link 'events' 'Eventos' %}
                        </li>
                        <!-- Ícono de notificaciones -->
                        <li class="nav-item dropdown position-relative">   <!-- position-relative asegura alineación -->
                            <a class="nav-link dropdown-toggle" href="#" id="notifMenu"
                               role="button" data-bs-toggle="dropdown" aria-expanded="false">
                               <i class="bi bi-bell fs-5"></i>
                               {% if unread_notifications %}
                                 <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">
                                   {{ unread_notifications }}
                                 </span>
                               {% endif %}
                            </a>
                          
                            <!-- dropdown-menu-end alinea a la derecha -->
                            <ul class="dropdown-menu dropdown-menu-end p-0"
                                aria-labelledby="notifMenu" style="min-width:260px"
                                id="notifDropdown">
                                <!-- aquí se inyecta HTML por AJAX -->
                            </ul>
                        </li>
                    </ul>
                </div>

                <form class="d-flex" action="{% url 'logout' %}" method="POST">
                    {% csrf_token %}
                    <button class="btn btn-sm btn-outline-secondary" type="submit">Salir</button>
                </form>
            {% else %}
                <div class="hstack gap-2">
                    <a class="btn btn-sm btn-outline-primary" href="{% url 'login' %}">Ingresá</a>
                    <a class="btn btn-sm btn-primary" href="{% url 'register' %}">Creá tu cuenta</a>
                </div>
            {% endif %}
        </div>
    </nav>

    <main class="container py-4">
        {% block content %}
        {% endblock %}
    </main>

    <script
        src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-k6d4wzSIapyDyv1kpU366/PK5hCdSbCRGRCMv+eplOQJWyd1fbcAu9OCUj5zNLiq"
        crossorigin="anonymous"
    ></script>
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const dropdown = document.getElementById("notifMenu");
            dropdown?.addEventListener("show.bs.dropdown", () => {
            fetch("{% url 'notifications_dropdown' %}")
                .then(r => r.json())
                .then(data => {
                document.getElementById("notifDropdown").innerHTML = data.html;
                });
            });
        });
    </script>
</body>

</html>
